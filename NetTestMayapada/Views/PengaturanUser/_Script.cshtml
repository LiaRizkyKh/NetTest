<script>
    var Table;

    $(document).ready(function () {
        LoadDataTable();
    });

    function LoadDataTable() {
        if (Table != undefined) {
            Table.destroy();
        }

        Table = $('#Table').DataTable({
            fixedHeader: {
                Headers: true
            },
            pageLength: 10,
            destroy: true,
            orderCellsTop: true,
            responsive: true,
            processing: true,
            serverSide: false,
            orderMulti: false,
            ordering: false,
            retrieve: true,
            dom: '<"top"i>rt<"bottom"lp><"clear">',
            ajax: {
                url: '/PengaturanUser/LoadData',
                type: "GET",
                datatype: "json"
            },
            columns: [
                { responsivePriority: 1, "data": "number", title: "No" },
                {
                    responsivePriority: 2,
                    "data": "userNumber", "name": "", title: "Action", "orderable": false, "visible": true, "render": function (data, type, full, meta) {
                        const email = String(full.email ?? full.Email ?? "");
                        const emailAttr = $('<div>').text(email).html();
                        return `
                                  <button class="btn btn-sm btn-warning me-2 btn-edit"  data-email="${emailAttr}">
                                    <i class="fa fa-pen color-white"></i>
                                  </button>
                                  <button class="btn btn-sm btn-danger btn-delete" data-email="${emailAttr}">
                                    <i class="fa fa-trash"></i>
                                  </button>`;
                    }
                },
                {
                    responsivePriority: 3,
                    data: "photoProfile",
                    title: "Foto Profil",
                    render: function (data) {
                        if (!data) {
                            return '<img src="/images/default-profile.png" width="40" height="40" class="rounded-circle"/>';
                        }
                        return '<img src="' + data + '" width="40" height="40" class="rounded-circle"/>';
                    }
                },
                { responsivePriority: 4, "data": "fullName", title: "Nama" },
                { responsivePriority: 5, "data": "email", title: "Email" },
                { responsivePriority: 6, "data": "level", title: "Level" },
                {
                    responsivePriority: 7, "data": "isActive", title: "Status", "render": function (data, type, full, meta) {
                        if (full.isActive == true) {
                            return '<button class="btn btn-success" style="width: 7rem">Aktif</button>'
                        }
                        else {
                            return '<button class="btn btn-danger" style="width: 7rem">Tidak Aktif</button>'
                        }
                    }
                }
            ],
            columnDefs: [
                {
                    render: function (data, type, full, meta) {
                        return "<div class='text-wrap width-comment'>" + data + "</div>";
                    },
                    targets: 6
                }
            ],
            // "order": [[4, "asc"]]
        });
    }

    $('#Table').on('click', '.btn-edit', function () {
        const email = $(this).data('email');
        const url = '@Url.Action("Edit", "PengaturanUser")' + '?email=' + encodeURIComponent(email);
        window.location.href = url;
    });

    $('#Table').on('click', '.btn-delete', function () {
        Delete($(this).data('email'));
    });

    function Delete(id) {
        State = "delete";
        swal({
            title: "Konfirmasi",
            text: "Apakah Anda yakin ingin menghapus data ini?",
            icon: "warning",
            buttons: true,
            dangerMode: true,
        })
            .then((willDelete) => {
                if (willDelete) {
                    $.ajax({
                        url: '@Url.Action("Delete", "PengaturanUser")',
                        type: 'POST',
                        data: { "email": id },
                        success: function (d) {
                            if (d == "") {
                                NotifikasiSukses("Sukses", "Data berhasil dihapus!");
                            } else {
                                NotifikasiError("Error", "Data gagal dihapus!")
                            }
                            Table.draw();
                        }
                    });
                }
            });
        return false;
    }

    // function ValidationForm() {
    //     $('#FormData').validate({
    //         rules: {
    //             FullName: {
    //                 required: true
    //             },
    //             Password: {
    //                 required: true,
    //                 minlength: 8,
    //                 maxlength: 16,
    //                 pattern: /(?=.[a-z])(?=.[A-Z])(?=.[0-9])(?=.[!@@#$%^&()\-=[\]{};':,.<>/?]{1,})[A-Za-z0-9!@@#$%^&()\-=[\]{};':,.<>/?]/
    //             },
    //             ConfirmPassword: {
    //                 required: true,
    //                 equalTo: "#Password"
    //             },
    //             Email: {
    //                 required: true,
    //                 email: true,
    //                 pattern: /^[a-zA-Z0-9_.-]+@@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/
    //             },
    //             IsActive: {
    //                 required: true
    //             }
    //         },
    //         messages: {
    //             FullName: {
    //                 required: "Harap isi field ini terlebih dahulu!"
    //             },
    //             Password: {
    //                 required: "Harap isi field ini terlebih dahulu!",
    //                 minlength: "Password minimal 8 karakter",
    //                 maxlength: "Password maksimal 16 karakter",
    //                 pattern: "Password harus terdiri dari huruf besar, huruf kecil, angka, dan karakter khusus"
    //             },
    //             ConfirmPassword: {
    //                 required: "Harap isi field ini terlebih dahulu!",
    //                 equalTo: "Konfirmasi password harus sama dengan password"
    //             },
    //             Email: {
    //                 required: "Harap isi field ini terlebih dahulu!",
    //                 email: "Format email tidak valid",
    //                 pattern: "Format email tidak valid"
    //             },
    //             IsActive: {
    //                 required: "Harap pilih salah satu opsi"
    //             }
    //         },
    //         errorElement: 'span',
    //         errorPlacement: function (error, element) {
    //             error.addClass('invalid-feedback');
    //             element.closest('.form-group').append(error);
    //         },
    //         highlight: function (element, errorClass, validClass) {
    //             $(element).addClass('is-invalid');
    //         },
    //         unhighlight: function (element, errorClass, validClass) {
    //             $(element).removeClass('is-invalid');
    //         }
    //     });

    //     $('#Submit').click(function () {
    //         var url = '';
    //         var $valid = $("#FormData").valid();
    //         if (!$valid) {
    //             return false;
    //         } else {
    //             if (State == "create") {
    //                 url = '@Url.Action("SubmitCreate", "PengaturanUser")';
    //             }
    //             else {
    //                 url = '@Url.Action("SubmitEdit", "PengaturanUser")';
    //             }
    //             $.ajax({
    //                 url: url,
    //                 type: 'POST',
    //                 data: $('#FormData').serialize(),
    //                 success: function (d) {
    //                     if (d == "") {
    //                         window.location.href = "../PengaturanUser/Index";
    //                         NotifikasiSukses("Sukses", "Data berhasil disimpan!");
    //                         Table.draw();
    //                     } else {
    //                         NotifikasiError("Error", d)
    //                     }
    //                 }
    //             });
    //         }
    //     });
    // }

</script>